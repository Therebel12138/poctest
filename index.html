<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebView æƒé™æµ‹è¯• PoC</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }
  .test-section {
    border: 1px solid #ddd;
    margin: 20px 0;
    padding: 15px;
    border-radius: 5px;
  }
  button {
    padding: 10px 15px;
    margin: 5px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  .result {
    margin: 10px 0;
    padding: 10px;
    background: #f8f9fa;
    border-left: 4px solid #007bff;
  }
  .success { border-left-color: #28a745; background: #d4edda; }
  .error { border-left-color: #dc3545; background: #f8d7da; }
  video, audio {
    width: 100%;
    max-width: 300px;
    border: 1px solid #ccc;
    margin: 10px 0;
  }
</style>
</head>
<body>
<h1>ğŸ” WebView æƒé™æµ‹è¯• PoC</h1>
<p>æ­¤é¡µé¢ç”¨äºæµ‹è¯• Android WebView çš„æƒé™å¤„ç†æ˜¯å¦å­˜åœ¨å®‰å…¨æ¼æ´</p>

<!-- æ‘„åƒå¤´æƒé™æµ‹è¯• -->
<div class="test-section">
  <h3>ğŸ“¹ æ‘„åƒå¤´æƒé™æµ‹è¯•</h3>
  <button onclick="testCamera()">è¯·æ±‚æ‘„åƒå¤´æƒé™</button>
  <button onclick="testCameraWithoutPermission()">ç›´æ¥è®¿é—®æ‘„åƒå¤´</button>
  <div id="camera-result" class="result"></div>
  <video id="camera-video" autoplay playsinline style="display:none;"></video>
</div>

<!-- éº¦å…‹é£æƒé™æµ‹è¯• -->
<div class="test-section">
  <h3>ğŸ¤ éº¦å…‹é£æƒé™æµ‹è¯•</h3>
  <button onclick="testMicrophone()">è¯·æ±‚éº¦å…‹é£æƒé™</button>
  <button onclick="testAudioRecording()">å¼€å§‹å½•éŸ³æµ‹è¯•</button>
  <div id="mic-result" class="result"></div>
  <audio id="audio-playback" controls style="display:none;"></audio>
</div>

<!-- åŒæ—¶è¯·æ±‚å¤šä¸ªæƒé™ -->
<div class="test-section">
  <h3>ğŸ”„ æ‰¹é‡æƒé™æµ‹è¯•</h3>
  <button onclick="testMultiplePermissions()">åŒæ—¶è¯·æ±‚æ‘„åƒå¤´+éº¦å…‹é£</button>
  <div id="multiple-result" class="result"></div>
  <video id="multiple-video" autoplay playsinline style="display:none;"></video>
</div>

<!-- æ¶æ„æµ‹è¯• -->
<div class="test-section">
  <h3>âš ï¸ æ½œåœ¨æ¶æ„è¡Œä¸ºæµ‹è¯•</h3>
  <button onclick="continuousAccess()">æŒç»­è®¿é—®æµ‹è¯•</button>
  <button onclick="backgroundAccess()">åå°è®¿é—®æµ‹è¯•</button>
  <div id="malicious-result" class="result"></div>
</div>

<!-- æƒé™ä¿¡æ¯æ”¶é›† -->
<div class="test-section">
  <h3>ğŸ“Š æƒé™ä¿¡æ¯æ”¶é›†</h3>
  <button onclick="collectPermissionInfo()">æ”¶é›†æƒé™ä¿¡æ¯</button>
  <div id="info-result" class="result"></div>
</div>

<script>
let mediaStream = null;
let mediaRecorder = null;
let recordedChunks = [];

// æµ‹è¯•æ‘„åƒå¤´æƒé™
async function testCamera() {
  const resultDiv = document.getElementById('camera-result');
  const video = document.getElementById('camera-video');
  
  try {
    resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...';
    
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: 'user'
      }
    });
    
    video.srcObject = stream;
    video.style.display = 'block';
    mediaStream = stream;
    
    resultDiv.innerHTML = 'âœ… æ‘„åƒå¤´æƒé™è·å–æˆåŠŸï¼å¯ä»¥è®¿é—®æ‘„åƒå¤´';
    resultDiv.className = 'result success';
    
    // è·å–æ‘„åƒå¤´ä¿¡æ¯
    const videoTrack = stream.getVideoTracks()[0];
    const settings = videoTrack.getSettings();
    resultDiv.innerHTML += `<br>ğŸ“± æ‘„åƒå¤´ä¿¡æ¯: ${settings.width}x${settings.height}, è®¾å¤‡ID: ${settings.deviceId}`;
    
  } catch (error) {
    resultDiv.innerHTML = `âŒ æ‘„åƒå¤´æƒé™è¢«æ‹’ç»: ${error.message}`;
    resultDiv.className = 'result error';
  }
}

// æµ‹è¯•éº¦å…‹é£æƒé™
async function testMicrophone() {
  const resultDiv = document.getElementById('mic-result');
  
  try {
    resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...';
    
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    });
    
    resultDiv.innerHTML = 'âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸï¼';
    resultDiv.className = 'result success';
    
    // è·å–éŸ³é¢‘è®¾å¤‡ä¿¡æ¯
    const audioTrack = stream.getAudioTracks()[0];
    const settings = audioTrack.getSettings();
    resultDiv.innerHTML += `<br>ğŸµ éŸ³é¢‘ä¿¡æ¯: é‡‡æ ·ç‡ ${settings.sampleRate}Hz, è®¾å¤‡ID: ${settings.deviceId}`;
    
    stream.getTracks().forEach(track => track.stop());
    
  } catch (error) {
    resultDiv.innerHTML = `âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»: ${error.message}`;
    resultDiv.className = 'result error';
  }
}

// æµ‹è¯•åŒæ—¶è¯·æ±‚å¤šä¸ªæƒé™
async function testMultiplePermissions() {
  const resultDiv = document.getElementById('multiple-result');
  const video = document.getElementById('multiple-video');
  
  try {
    resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨åŒæ—¶è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™...';
    
    const stream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });
    
    video.srcObject = stream;
    video.style.display = 'block';
    
    resultDiv.innerHTML = 'âœ… æˆåŠŸè·å–æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™ï¼';
    resultDiv.className = 'result success';
    
    const videoTracks = stream.getVideoTracks();
    const audioTracks = stream.getAudioTracks();
    
    resultDiv.innerHTML += `<br>ğŸ“¹ è§†é¢‘è½¨é“: ${videoTracks.length}ä¸ª`;
    resultDiv.innerHTML += `<br>ğŸ¤ éŸ³é¢‘è½¨é“: ${audioTracks.length}ä¸ª`;
    
  } catch (error) {
    resultDiv.innerHTML = `âŒ æƒé™è¯·æ±‚å¤±è´¥: ${error.message}`;
    resultDiv.className = 'result error';
  }
}

// å½•éŸ³æµ‹è¯•
async function testAudioRecording() {
  const resultDiv = document.getElementById('mic-result');
  const audioPlayback = document.getElementById('audio-playback');
  
  try {
    if (!mediaRecorder) {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      recordedChunks = [];
      
      mediaRecorder.ondataavailable = function(event) {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };
      
      mediaRecorder.onstop = function() {
        const blob = new Blob(recordedChunks, { type: 'audio/wav' });
        const audioURL = URL.createObjectURL(blob);
        audioPlayback.src = audioURL;
        audioPlayback.style.display = 'block';
        resultDiv.innerHTML += '<br>ğŸµ å½•éŸ³å®Œæˆï¼Œå¯ä»¥æ’­æ”¾ï¼';
      };
      
      mediaRecorder.start();
      resultDiv.innerHTML += '<br>ğŸ”´ å¼€å§‹å½•éŸ³...ï¼ˆ3ç§’åè‡ªåŠ¨åœæ­¢ï¼‰';
      
      setTimeout(() => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
      }, 3000);
    }
  } catch (error) {
    resultDiv.innerHTML += `<br>âŒ å½•éŸ³å¤±è´¥: ${error.message}`;
  }
}

// æ¶æ„è¡Œä¸ºæµ‹è¯•ï¼šæŒç»­è®¿é—®
async function continuousAccess() {
  const resultDiv = document.getElementById('malicious-result');
  
  try {
    resultDiv.innerHTML = 'âš ï¸ å¼€å§‹æŒç»­è®¿é—®æ‘„åƒå¤´æµ‹è¯•...';
    
    for (let i = 0; i < 10; i++) {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      setTimeout(() => {
        stream.getTracks().forEach(track => track.stop());
      }, 1000);
      
      resultDiv.innerHTML += `<br>ç¬¬${i+1}æ¬¡è®¿é—®æˆåŠŸ`;
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    resultDiv.innerHTML += '<br>âœ… æŒç»­è®¿é—®æµ‹è¯•å®Œæˆ - å¯èƒ½å­˜åœ¨æƒé™æ§åˆ¶ç»•è¿‡ï¼';
    resultDiv.className = 'result success';
    
  } catch (error) {
    resultDiv.innerHTML += `<br>âŒ æŒç»­è®¿é—®è¢«é˜»æ­¢: ${error.message}`;
    resultDiv.className = 'result error';
  }
}

// åå°è®¿é—®æµ‹è¯•
function backgroundAccess() {
  const resultDiv = document.getElementById('malicious-result');
  
  resultDiv.innerHTML = 'âš ï¸ æµ‹è¯•é¡µé¢éšè—æ—¶çš„æƒé™è®¿é—®...';
  
  // æ¨¡æ‹Ÿé¡µé¢éšè—
  setTimeout(async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: true, 
        audio: true 
      });
      
      resultDiv.innerHTML += '<br>ğŸš¨ å±é™©ï¼šåœ¨é¡µé¢éšè—çŠ¶æ€ä¸‹ä»å¯è®¿é—®æ‘„åƒå¤´å’Œéº¦å…‹é£ï¼';
      resultDiv.className = 'result error';
      
      // 2ç§’åå…³é—­
      setTimeout(() => {
        stream.getTracks().forEach(track => track.stop());
      }, 2000);
      
    } catch (error) {
      resultDiv.innerHTML += '<br>âœ… åå°è®¿é—®è¢«æ­£ç¡®é˜»æ­¢';
      resultDiv.className = 'result success';
    }
  }, 1000);
}

// æ”¶é›†æƒé™å’Œè®¾å¤‡ä¿¡æ¯
async function collectPermissionInfo() {
  const resultDiv = document.getElementById('info-result');
  let info = '<h4>ğŸ“Š è®¾å¤‡å’Œæƒé™ä¿¡æ¯ï¼š</h4>';
  
  try {
    // è·å–åª’ä½“è®¾å¤‡åˆ—è¡¨
    const devices = await navigator.mediaDevices.enumerateDevices();
    
    info += `<br><strong>ğŸ¥ è§†é¢‘è®¾å¤‡:</strong>`;
    devices.filter(device => device.kind === 'videoinput').forEach((device, index) => {
      info += `<br>  ${index + 1}. ${device.label || 'æ‘„åƒå¤´'} (ID: ${device.deviceId.substring(0, 10)}...)`;
    });
    
    info += `<br><strong>ğŸ¤ éŸ³é¢‘è¾“å…¥è®¾å¤‡:</strong>`;
    devices.filter(device => device.kind === 'audioinput').forEach((device, index) => {
      info += `<br>  ${index + 1}. ${device.label || 'éº¦å…‹é£'} (ID: ${device.deviceId.substring(0, 10)}...)`;
    });
    
    info += `<br><strong>ğŸ”Š éŸ³é¢‘è¾“å‡ºè®¾å¤‡:</strong>`;
    devices.filter(device => device.kind === 'audiooutput').forEach((device, index) => {
      info += `<br>  ${index + 1}. ${device.label || 'æ‰¬å£°å™¨'} (ID: ${device.deviceId.substring(0, 10)}...)`;
    });
    
    // æµè§ˆå™¨ä¿¡æ¯
    info += `<br><br><strong>ğŸŒ æµè§ˆå™¨ä¿¡æ¯:</strong>`;
    info += `<br>User Agent: ${navigator.userAgent}`;
    info += `<br>å½“å‰åŸŸå: ${window.location.origin}`;
    info += `<br>åè®®: ${window.location.protocol}`;
    
    // æƒé™APIæµ‹è¯•
    if ('permissions' in navigator) {
      try {
        const cameraPermission = await navigator.permissions.query({name: 'camera'});
        const micPermission = await navigator.permissions.query({name: 'microphone'});
        
        info += `<br><br><strong>ğŸ”’ æƒé™çŠ¶æ€:</strong>`;
        info += `<br>æ‘„åƒå¤´: ${cameraPermission.state}`;
        info += `<br>éº¦å…‹é£: ${micPermission.state}`;
      } catch (e) {
        info += `<br><br><strong>ğŸ”’ æƒé™APIä¸å¯ç”¨</strong>`;
      }
    }
    
    resultDiv.innerHTML = info;
    resultDiv.className = 'result success';
    
  } catch (error) {
    resultDiv.innerHTML = `âŒ ä¿¡æ¯æ”¶é›†å¤±è´¥: ${error.message}`;
    resultDiv.className = 'result error';
  }
}

// é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
window.addEventListener('beforeunload', () => {
  if (mediaStream) {
    mediaStream.getTracks().forEach(track => track.stop());
  }
});

// è‡ªåŠ¨å¼€å§‹åŸºç¡€æµ‹è¯•
window.addEventListener('load', () => {
  setTimeout(() => {
    collectPermissionInfo();
  }, 1000);
});
</script>

</body>
</html>
